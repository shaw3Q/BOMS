<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Form with Cloudinary & Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    .form-container {
      flex: 0 0 20%;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .list-container {
      flex: 0 0 80%;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-card label {
      display: block;
      margin-top: 10px;
    }
    .form-card input[type="text"],
    .form-card input[type="date"],
    .form-card input[type="file"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .status-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 5px;
    }
    .status-options input[type="radio"] {
      display: none;
    }
    .status-options label {
      padding: 10px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background-color: #f0f0f0;
      user-select: none;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    .status-options input#received:checked + label {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .status-options input#ongoing:checked + label {
      background-color: #fd7e14;
      color: white;
      border-color: #fd7e14;
    }
    .status-options input#finished:checked + label {
      background-color: #28a745;
      color: white;
      border-color: #28a745;
    }
    .status-options input#released:checked + label {
      background-color: #6f42c1;
      color: white;
      border-color: #6f42c1;
    }
    .preview-img {
      margin-top: 10px;
      max-width: 100%;
      height: auto;
      display: block;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #f0f0f0;
    }
    /* Status cell colors */
    .status-cell.received {
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      padding: 4px 8px;
      text-align: center;
    }
    .status-cell.ongoing {
      background-color: #fd7e14;
      color: white;
      border-radius: 4px;
      padding: 4px 8px;
      text-align: center;
    }
    .status-cell.finished {
      background-color: #28a745;
      color: white;
      border-radius: 4px;
      padding: 4px 8px;
      text-align: center;
    }
    .status-cell.released {
      background-color: #6f42c1;
      color: white;
      border-radius: 4px;
      padding: 4px 8px;
      text-align: center;
    }
    /* Larger images in table */
    .orders-img {
      max-width: 80px;
      max-height: 50px;
      cursor: pointer;
      border-radius: 4px;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Order Form</h2>
    <div class="form-card">
      <form id="orderForm">
        <input type="hidden" id="docId" />

        <label>Team Name</label>
        <input type="text" id="teamName" required />

        <label>Status</label>
        <div class="status-options">
          <input type="radio" id="received" name="status" value="Received" checked />
          <label for="received">Received</label>

          <input type="radio" id="ongoing" name="status" value="On going" />
          <label for="ongoing">On going</label>

          <input type="radio" id="finished" name="status" value="Finished" />
          <label for="finished">Finished</label>

          <input type="radio" id="released" name="status" value="Released" />
          <label for="released">Released</label>
        </div>

        <label>Due Date</label>
        <input type="date" id="dueDate" />

        <label>Upload Image</label>
        <input type="file" id="imageUpload" accept="image/*" />
        <img id="preview" class="preview-img" />

        <button type="submit">Save</button>
      </form>
    </div>
  </div>

  <div class="list-container">
    <h2>Orders</h2>
    <input type="text" id="searchTeam" placeholder="Search team name..." />
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Team</th>
          <th>Tailor</th>
          <th>Status</th>
          <th>Due Date</th>
          <th>Image</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCWCUiCICoraIkT6QawtM18WenCzm4tBPI",
      authDomain: "boms-c7893.firebaseapp.com",
      projectId: "boms-c7893",
      storageBucket: "boms-c7893.firebasestorage.app",
      messagingSenderId: "388757655613",
      appId: "1:388757655613:web:aedd6ba996520d8739da54"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Cloudinary config
    const cloudName = "dmyne19qj";
    const uploadPreset = "upload_preset_boms";

    const orderForm = document.getElementById("orderForm");
    const ordersTableBody = document.querySelector("#ordersTable tbody");
    const preview = document.getElementById("preview");
    const imageUpload = document.getElementById("imageUpload");
    const dueDateInput = document.getElementById("dueDate");
    const searchTeam = document.getElementById("searchTeam");

    // Set due date default 5 days later
    const today = new Date();
    today.setDate(today.getDate() + 5);
    dueDateInput.valueAsDate = today;

    // Show image preview
    imageUpload.addEventListener("change", () => {
      const file = imageUpload.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => preview.src = e.target.result;
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
      }
    });

    // Save or update order
    orderForm.addEventListener("submit", async e => {
      e.preventDefault();
      const docId = document.getElementById("docId").value;
      const teamName = document.getElementById("teamName").value.trim();
      const status = document.querySelector('input[name="status"]:checked').value;
      const dueDate = dueDateInput.value;
      let imageUrl = preview.src || "";

      // Upload image to Cloudinary if new image selected and not already a URL
      if (imageUpload.files.length > 0 && !imageUrl.startsWith("http")) {
imageUrl = await uploadImageToCloudinary(imageUpload.files[0]);
}
      const data = {
    teamName,
    status,
    dueDate,
    imageUrl,
    tailor: "",  // Placeholder for now
  };

  try {
    if (docId) {
      await db.collection("orders").doc(docId).update(data);
    } else {
      await db.collection("orders").add(data);
    }
    resetForm();
    loadOrders();
  } catch (error) {
    alert("Error saving data: " + error.message);
  }
});

// Upload image to Cloudinary with compression under 500kb
async function uploadImageToCloudinary(file) {
  // Resize image in browser before upload (to keep under 500kb)
  const resizedFile = await resizeImage(file, 1024, 1024, 0.75);

  const formData = new FormData();
  formData.append("file", resizedFile);
  formData.append("upload_preset", uploadPreset);

  const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
    method: "POST",
    body: formData,
  });

  const data = await res.json();
  return data.secure_url;
}

// Resize image function (canvas-based)
function resizeImage(file, maxWidth, maxHeight, quality = 0.8) {
  return new Promise((resolve) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => {
      img.src = e.target.result;
    };
    img.onload = () => {
      let { width, height } = img;

      if (width > maxWidth) {
        height = Math.round((height * maxWidth) / width);
        width = maxWidth;
      }
      if (height > maxHeight) {
        width = Math.round((width * maxHeight) / height);
        height = maxHeight;
      }

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      canvas.toBlob(
        (blob) => {
          resolve(new File([blob], file.name, { type: file.type }));
        },
        file.type,
        quality
      );
    };
    reader.readAsDataURL(file);
  });
}

// Load orders from Firestore
async function loadOrders() {
  const searchValue = searchTeam.value.trim().toLowerCase();
  const snapshot = await db.collection("orders").orderBy("dueDate").get();

  let orders = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    data.id = doc.id;
    if (!searchValue || (data.teamName && data.teamName.toLowerCase().includes(searchValue))) {
      orders.push(data);
    }
  });

  renderOrders(orders);
}

// Render orders in table
function renderOrders(orders) {
  ordersTableBody.innerHTML = "";
  orders.forEach(order => {
    const tr = document.createElement("tr");

    // Team Name
    const teamTd = document.createElement("td");
    teamTd.textContent = order.teamName || "";
    tr.appendChild(teamTd);

    // Tailor placeholder
    const tailorTd = document.createElement("td");
    tailorTd.textContent = order.tailor || "";
    tr.appendChild(tailorTd);

    // Status with color
    const statusTd = document.createElement("td");
    statusTd.textContent = order.status;
    statusTd.classList.add("status-cell", order.status.toLowerCase().replace(/\s/g, ""));
    tr.appendChild(statusTd);

    // Due Date
    const dueTd = document.createElement("td");
    dueTd.textContent = order.dueDate || "";
    tr.appendChild(dueTd);

    // Image (click to enlarge)
    const imgTd = document.createElement("td");
    if (order.imageUrl) {
      const img = document.createElement("img");
      img.src = order.imageUrl;
      img.alt = "Order Image";
      img.className = "orders-img";
      img.style.cursor = "pointer";
      img.onclick = () => window.open(order.imageUrl, "_blank");
      imgTd.appendChild(img);
    }
    tr.appendChild(imgTd);

    // Actions (Edit/Delete)
    const actionsTd = document.createElement("td");

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.style.marginRight = "8px";
    editBtn.onclick = () => editOrder(order);
    actionsTd.appendChild(editBtn);

    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.onclick = () => deleteOrder(order.id);
    actionsTd.appendChild(delBtn);

    tr.appendChild(actionsTd);

    ordersTableBody.appendChild(tr);
  });
}

// Edit order: fill form with data
function editOrder(order) {
  document.getElementById("docId").value = order.id || "";
  document.getElementById("teamName").value = order.teamName || "";
  document.querySelectorAll('input[name="status"]').forEach(radio => {
    radio.checked = radio.value === order.status;
  });
  dueDateInput.value = order.dueDate || "";
  preview.src = order.imageUrl || "";
  imageUpload.value = "";
}

// Delete order
async function deleteOrder(id) {
  if (confirm("Are you sure you want to delete this order?")) {
    await db.collection("orders").doc(id).delete();
    loadOrders();
  }
}

// Reset form
function resetForm() {
  orderForm.reset();
  document.getElementById("docId").value = "";
  preview.src = "";
  // Reset due date to 5 days later
  const newDate = new Date();
  newDate.setDate(newDate.getDate() + 5);
  dueDateInput.valueAsDate = newDate;
}

// Load orders initially
loadOrders();

// Search functionality
searchTeam.addEventListener("input", loadOrders);
    </script> </body> </html>
